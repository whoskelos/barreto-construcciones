---
import { Image } from "astro:assets";
import { getImage } from "astro:assets";

import heroImage1 from "@assets/img/carousel/edificacion.webp";
import heroImage2 from "@assets/img/carousel/obra_civil.webp";
import heroImage3 from "@assets/img/carousel/rehabilitación.webp";
import heroImage4 from "@assets/img/carousel/reforma.webp";
import heroImage5 from "@assets/img/carousel/mantenimiento.webp";

const slides = [
    {
        id: 1,
        image: heroImage1,
        alt: "Edificación de gasolinera moderna",
    },
    {
        id: 2,
        image: heroImage2,
        alt: "Obra Civil aeroportuaria - asfaltado de pista de aterrizaje",
    },
    {
        id: 3,
        image: heroImage3,
        alt: "Rehabilitación de piscina natural",
    },
    {
        id: 4,
        image: heroImage4,
        alt: "Reforma de cocina moderna y elegante",
    },
    {
        id: 5,
        image: heroImage5,
        alt: "Mantenimiento y pintura deposito industrial",
    },
];

const slidesWithBlur = await Promise.all(slides.map(async (slide) => {
    const blurImage = await getImage({
        src: slide.image,
        format: "webp",
        width: 150,
        quality: 50
    });
    return {
        ...slide,
        blurImage: blurImage.src
    };
}));
---

<section class="relative w-full h-[70dvh] overflow-hidden bg-neutral-900" role="region" aria-label="Banner principal con carrusel de proyectos">
    <!-- Carousel Viewport -->
    <div class="carousel-viewport absolute inset-0 w-full h-full">
        {
            slidesWithBlur.map((slide, index) => {
                // Restamos 1.2s (4% de 30s) extra para que la primera imagen empiece ya posicionada (fase estática)
                // y no veamos la animación de entrada al cargar la página.
                const delay = (index * 6) - 30 - 1.2;
                return (
                    <div 
                        class="carousel-slide absolute inset-0 w-full h-full"
                        style={`animation-delay: ${delay}s;`}
                    >
                        {/* Low Res Placeholder */}
                        <img
                            src={slide.blurImage}
                            alt=""
                            class="carousel-image absolute inset-0 w-full h-full object-cover brightness-[0.3] contrast-[1.1] blur-sm"
                            aria-hidden="true"
                        />
                        
                        {/* High Res Image */}
                        <Image
                            src={slide.image}
                            alt={slide.alt}
                            class="carousel-image-high carousel-image relative w-full h-full object-cover brightness-[0.3] contrast-[1.1] opacity-0 transition-opacity duration-1200 ease-out"
                            loading={index === 0 ? "eager" : "lazy"}
                            decoding="async"
                            quality={80}
                            widths={[640, 1024, 1536, 2048]}
                            sizes="100vw"
                            format="avif"
                        />
                    </div>
                );
            })
        }
    </div>

    <!-- Static Content Overlay -->
    <div class="absolute inset-0 flex items-center z-20 pointer-events-none">
        <div class="container mx-auto px-4 sm:px-8 lg:px-8">
            <div class="max-w-3xl hero-content pointer-events-auto">
                <h1
                    class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold text-neutral-50 leading-tight mb-6 sm:mb-0 tracking-tight"
                >
                    Construimos confianza.
                    <br />
                    <span class="text-primary-500">Rehabilitamos el futuro.</span
                    >
                </h1>
                <p
                    class="text-lg sm:text-xl md:text-2xl text-[hsl(var(--hero-text))]/90 mb-8 sm:mb-0 max-w-2xl"
                >
                    Expertos en construcción y mantenimiento con más de 20 años de experiencia
                </p>
            </div>
        </div>
    </div>
</section>

<style>
    :root {
        --total-time: 30s;
    }

    .carousel-viewport {
        contain: paint layout;
    }

    .carousel-slide {
        will-change: transform;
        transform: translate3d(100%, 0, 0);
        animation: carouselCycle var(--total-time) linear infinite;
        backface-visibility: hidden;
        z-index: 1;
    }

    .carousel-image {
        animation: subtleScale 15s alternate infinite ease-in-out;
    }

    @keyframes carouselCycle {
        /* FASE 1: ENTRADA (Slide In) */
        0% {
            transform: translate3d(100%, 0, 0);
            z-index: 10;
        }
        4% {
            transform: translate3d(0, 0, 0);
            z-index: 10;
        }
        
        /* FASE 2: LECTURA (Static) */
        20% {
            transform: translate3d(0, 0, 0);
            z-index: 10;
        }

        /* FASE 3: SALIDA (Slide Out) */
        24% {
            transform: translate3d(-100%, 0, 0);
            z-index: 10;
        }

        /* FASE 4: RESET */
        24.01% {
            transform: translate3d(100%, 0, 0);
            z-index: -1;
        }
        100% {
            transform: translate3d(100%, 0, 0);
            z-index: -1;
        }
    }

    @keyframes subtleScale {
        0% { transform: scale(1.05); }
        100% { transform: scale(1.15); }
    }

    /* Animación suave para el contenido del hero */
    .hero-content {
        animation: fadeInUp 1.2s ease-out 0.4s forwards;
        opacity: 0;
    }

    @keyframes fadeInUp {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (prefers-reduced-motion: reduce) {
        .hero-content {
            animation: none;
            opacity: 1;
            transform: none;
        }
        
        .carousel-slide,
        .carousel-image {
            animation: none;
            transform: none;
        }
        
        .carousel-slide {
            position: absolute;
            inset: 0;
            opacity: 0;
        }
        
        .carousel-slide:first-child {
            opacity: 1;
        }
    }
</style>

<script>
    function initImageLoad() {
        const images = document.querySelectorAll('.carousel-image-high');
        images.forEach((img) => {
            if (img instanceof HTMLImageElement) {
                if (img.complete) {
                    img.classList.remove('opacity-0');
                } else {
                    img.addEventListener('load', () => {
                        img.classList.remove('opacity-0');
                    });
                }
            }
        });
    }

    // Ejecutar en carga inicial y navegaciones
    document.addEventListener('astro:page-load', initImageLoad);
    // Ejecutar inmediatamente por si acaso (para la primera carga)
    initImageLoad();
</script>
