---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";

// Obtener todos los proyectos de la colección
const allProjects = await getCollection("projects");

// Función para mezclar el array aleatoriamente (Fisher-Yates shuffle)
function shuffleArray<T>(array: T[]): T[] {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
}

// Mezclar proyectos para que varíen en cada build/render
const shuffledProjects = shuffleArray(allProjects);

// Distribuir proyectos en 3 filas
const row1 = shuffledProjects.filter((_, i) => i % 3 === 0);
const row2 = shuffledProjects.filter((_, i) => i % 3 === 1);
const row3 = shuffledProjects.filter((_, i) => i % 3 === 2);
---

<section class="bg-neutral-100 py-16 md:py-24 overflow-hidden">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <h2
            class="text-3xl sm:text-4xl md:text-5xl text-neutral-900 font-bold mb-4"
        >
            Proyectos destacados
        </h2>
        <p class="text-md text-neutral-800 pb-12">
            Descubre algunos de nuestros trabajos más representativos que
            demuestran nuestra experiencia y compromiso con la excelencia.
        </p>

        <div class="featured-projects-container space-y-6">
            {/* Row 1 */}
            <div class="featured-row-wrapper w-full overflow-hidden rounded-lg">
                <div class="featured-track featured-track-1 flex gap-4 w-max min-w-full">
                    {
                        row1.map((project) => (
                            <div class="relative shrink-0 rounded-lg overflow-hidden bg-neutral-200 aspect-video w-[280px] sm:w-[350px] md:w-[400px] group">
                                <Image
                                    src={project.data.image}
                                    alt={project.data.obra}
                                    width={400}
                                    height={225}
                                    decoding="async"
                                    loading="lazy"
                                    quality={70}
                                    widths={[250, 400]}
                                    sizes="(max-width: 768px) 250px, 300px"
                                    format="avif"
                                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                                />
                                <div class="absolute inset-0 bg-linear-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
                                    <p class="text-white font-medium text-sm truncate">{project.data.obra}</p>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>

            {/* Row 2 */}
            <div class="featured-row-wrapper w-full overflow-hidden rounded-lg">
                <div class="featured-track featured-track-2 flex gap-4 w-max min-w-full">
                    {
                        row2.map((project) => (
                            <div class="relative shrink-0 rounded-lg overflow-hidden bg-neutral-200 aspect-video w-[280px] sm:w-[350px] md:w-[400px] group">
                                <Image
                                    src={project.data.image}
                                    alt={project.data.obra}
                                    width={400}
                                    height={225}
                                    decoding="async"
                                    loading="lazy"
                                    quality={70}
                                    widths={[250, 400]}
                                    sizes="(max-width: 768px) 250px, 300px"
                                    format="avif"
                                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                                />
                                <div class="absolute inset-0 bg-linear-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
                                    <p class="text-white font-medium text-sm truncate">{project.data.obra}</p>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>

            {/* Row 3 */}
            <div class="featured-row-wrapper w-full overflow-hidden rounded-lg">
                <div class="featured-track featured-track-3 flex gap-4 w-max min-w-full">
                    {
                        row3.map((project) => (
                            <div class="relative shrink-0 rounded-lg overflow-hidden bg-neutral-200 aspect-video w-[280px] sm:w-[350px] md:w-[400px] group">
                                <Image
                                    src={project.data.image}
                                    alt={project.data.obra}
                                    width={400}
                                    height={225}
                                    decoding="async"
                                    loading="lazy"
                                    quality={70}
                                    widths={[250, 400]}
                                    sizes="(max-width: 768px) 250px, 300px"
                                    format="avif"
                                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                                />
                                <div class="absolute inset-0 bg-linear-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
                                    <p class="text-white font-medium text-sm truncate">{project.data.obra}</p>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .featured-track {
        will-change: transform;
        transform: translateZ(0);
        backface-visibility: hidden;
        /* Optimización para evitar parpadeos */
        -webkit-font-smoothing: antialiased;
    }

    @media (prefers-reduced-motion: reduce) {
        .featured-track {
            will-change: auto;
            transform: none !important;
        }
    }
</style>

<script>
    async function initFeaturedProjects() {
        const container = document.querySelector(".featured-projects-container");
        
        if (!container) return;

        // Respetar preferencia de movimiento reducido
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (prefersReducedMotion) return;

        const { gsap } = await import("gsap");
        const { ScrollTrigger } = await import("gsap/ScrollTrigger");
        
        gsap.registerPlugin(ScrollTrigger);

        // Limpiar animaciones previas
        ScrollTrigger.getAll().forEach(st => st.kill());

        const tracks = [
            { el: document.querySelector(".featured-track-1"), reverse: false },
            { el: document.querySelector(".featured-track-2"), reverse: true },
            { el: document.querySelector(".featured-track-3"), reverse: false }
        ];

        const tl = gsap.timeline({
            scrollTrigger: {
                trigger: container,
                start: "top bottom",
                end: "bottom top",
                scrub: 1, // Suavizado aumentado para reducir vibraciones
                invalidateOnRefresh: true,
            },
        });

        tracks.forEach(({ el, reverse }) => {
            if (!el || !(el instanceof HTMLElement)) return;
            
            const getScrollDist = () => {
                const parent = el.parentElement;
                if (!parent) return 0;
                // Calculamos la distancia necesaria para mostrar todo el contenido
                return el.scrollWidth - parent.clientWidth;
            };

            tl.fromTo(el, 
                { 
                    x: () => reverse ? -getScrollDist() : 0 
                },
                { 
                    x: () => reverse ? 0 : -getScrollDist(), 
                    ease: "none", 
                    force3D: true 
                },
                0
            );
        });
    }

    // Inicializar en carga de página (compatible con view transitions)
    document.addEventListener('astro:page-load', initFeaturedProjects);
</script>
