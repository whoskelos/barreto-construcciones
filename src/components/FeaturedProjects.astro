---
import { Image } from "astro:assets";
// Edificación
import edificacion1 from "@assets/img/featured/edificacion/1-min.webp";
import edificacion2 from "@assets/img/featured/edificacion/2-min.webp";
import edificacion3 from "@assets/img/featured/edificacion/3-min.webp";
import edificacion4 from "@assets/img/featured/edificacion/4-min.webp";

// Mantenimiento
import mantenimiento1 from "@assets/img/featured/mantenimiento/1-min.webp";
import mantenimiento2 from "@assets/img/featured/mantenimiento/2-min.webp";

// Obra Civil
import obraCivil1 from "@assets/img/featured/obra_civil/1-min.webp";
import obraCivil2 from "@assets/img/featured/obra_civil/2-min.webp";
import obraCivil3 from "@assets/img/featured/obra_civil/3-min.webp";
import obraCivil4 from "@assets/img/featured/obra_civil/4-min.webp";
import obraCivil5 from "@assets/img/featured/obra_civil/5-min.webp";

// Reformas
import reformas1 from "@assets/img/featured/reformas/1-min.webp";
import reformas2 from "@assets/img/featured/reformas/2-min.webp";
import reformas3 from "@assets/img/featured/reformas/3-min.webp";

// Rehabilitación
import rehabilitacion1 from "@assets/img/featured/rehabilitacion/1-min.webp";
import rehabilitacion2 from "@assets/img/featured/rehabilitacion/2-min.webp";
import rehabilitacion3 from "@assets/img/featured/rehabilitacion/3-min.webp";
import rehabilitacion4 from "@assets/img/featured/rehabilitacion/4-min.webp";

const featuredProjects1 = [
    {
        title: "Edificación",
        image: edificacion1,
        description: "Edificación",
    },
    {
        title: "Edificación",
        image: edificacion2,
        description: "Edificación",
    },
    {
        title: "Edificación",
        image: edificacion3,
        description: "Edificación",
    },
    {
        title: "Edificación",
        image: edificacion4,
        description: "Edificación",
    },
    {
        title: "Mantenimiento",
        image: mantenimiento1,
        description: "Mantenimiento",
    },
    {
        title: "Mantenimiento",
        image: mantenimiento2,
        description: "Mantenimiento",
    },
];

const featuredProjects2 = [
    {
        title: "Obra Civil",
        image: obraCivil1,
        description: "Obra Civil",
    },
    {
        title: "Obra Civil",
        image: obraCivil2,
        description: "Obra Civil",
    },
    {
        title: "Obra Civil",
        image: obraCivil3,
        description: "Obra Civil",
    },
    {
        title: "Obra Civil",
        image: obraCivil4,
        description: "Obra Civil",
    },
    {
        title: "Obra Civil",
        image: obraCivil5,
        description: "Obra Civil",
    },
    {
        title: "Reformas",
        image: reformas1,
        description: "Reformas",
    },
];

const featuredProjects3 = [
    {
        title: "Reformas",
        image: reformas2,
        description: "Reformas",
    },
    {
        title: "Reformas",
        image: reformas3,
        description: "Reformas",
    },
    {
        title: "Rehabilitación",
        image: rehabilitacion1,
        description: "Rehabilitación",
    },
    {
        title: "Rehabilitación",
        image: rehabilitacion2,
        description: "Rehabilitación",
    },
    {
        title: "Rehabilitación",
        image: rehabilitacion3,
        description: "Rehabilitación",
    },
    {
        title: "Rehabilitación",
        image: rehabilitacion4,
        description: "Rehabilitación",
    },
];
---

<section class="bg-neutral-100 py-16 md:py-24">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <h2
            class="text-3xl sm:text-4xl md:text-5xl text-neutral-900 font-bold mb-4"
        >
            Proyectos destacados
        </h2>
        <p class="text-md text-neutral-800 pb-12">
            Descubre algunos de nuestros trabajos más representativos que
            demuestran nuestra experiencia y compromiso con la excelencia.
        </p>

        <div class="featured-projects-container space-y-4">
            <div class="featured-projects featured-row w-full flex gap-4 overflow-hidden rounded-md">
                {
                    featuredProjects1.map((project) => (
                            <Image
                                src={project.image}
                                alt={project.title}
                                width={400}
                                height={225}
                                decoding="async"
                                loading="eager"
                                quality={85}
                                class="featured-project featured-project-1 object-cover aspect-video rounded-md shrink-0"
                            />
                    ))
                }
            </div>
            <div class="featured-projects featured-row w-full flex gap-4 overflow-hidden rounded-md">
                {
                    featuredProjects2.map((project) => (
                            <Image
                                src={project.image}
                                alt={project.title}
                                width={400}
                                height={225}
                                decoding="async"
                                loading="lazy"
                                quality={85}
                                class="featured-project featured-project-2 object-cover aspect-video rounded-md shrink-0"
                            />
                    ))
                }
            </div>
            <div class="featured-projects featured-row w-full flex gap-4 overflow-hidden rounded-md">
                {
                    featuredProjects3.map((project) => (
                            <Image
                                src={project.image}
                                alt={project.title}
                                width={400}
                                height={225}
                                decoding="async"
                                loading="lazy"
                                quality={85}
                                class="featured-project featured-project-3 object-cover aspect-video rounded-md shrink-0"
                            />
                    ))
                }
            </div>
        </div>
    </div>
</section>

<style>
    .featured-projects-container {
        contain: layout style paint;
    }

    .featured-row {
        will-change: transform;
        transform: translateZ(0);
        backface-visibility: hidden;
        perspective: 1000px;
    }

    .featured-project {
        will-change: transform;
        transform: translateZ(0);
        backface-visibility: hidden;
        width: clamp(250px, 30vw, 400px);
    }

    @media (prefers-reduced-motion: reduce) {
        .featured-project,
        .featured-row {
            will-change: auto;
        }
    }
</style>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";
    
    gsap.registerPlugin(ScrollTrigger);

    function initFeaturedProjects() {
        const container = document.querySelector(".featured-projects-container");
        
        if (!container) return;

        // Limpiar animaciones previas
        ScrollTrigger.getAll().forEach(st => st.kill());

        const projects = gsap.utils.toArray(".featured-project-1");
        const projects2 = gsap.utils.toArray(".featured-project-2");
        const projects3 = gsap.utils.toArray(".featured-project-3");

        if (projects.length === 0 || projects2.length === 0 || projects3.length === 0) {
            return;
        }

        // Establecer posiciones iniciales
        gsap.set(projects, { x: 0, force3D: true });
        gsap.set(projects2, { x: () => -100 * (projects2.length - 1) + "%", force3D: true });
        gsap.set(projects3, { x: 0, force3D: true });

        // Crear timeline con configuración optimizada
        const tl = gsap.timeline({
            scrollTrigger: {
                trigger: container,
                start: "top 80%",
                end: "bottom 20%",
                scrub: 0.5,
                invalidateOnRefresh: true,
            },
        });

        // Animaciones usando x en lugar de xPercent para mejor rendimiento
        tl.to(projects, {
            x: () => -100 * (projects.length - 1) + "%",
            ease: "none",
            force3D: true,
        }, 0)
        .to(projects2, {
            x: 0,
            ease: "none",
            force3D: true,
        }, 0)
        .to(projects3, {
            x: () => -100 * (projects3.length - 1) + "%",
            ease: "none",
            force3D: true,
        }, 0);
    }

    // Inicializar en carga de página (compatible con view transitions)
    document.addEventListener('astro:page-load', initFeaturedProjects);

    // Optimización: Pausar ScrollTrigger cuando la pestaña no está visible
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            ScrollTrigger.getAll().forEach(st => st.disable());
        } else {
            ScrollTrigger.getAll().forEach(st => st.enable());
        }
    });
</script>
