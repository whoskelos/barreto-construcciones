---
const GOOGLE_ADS_ID = import.meta.env.PUBLIC_GOOGLE_ADS_ID;
const GOOGLE_ADS_CONVERSION_LABEL = import.meta.env.PUBLIC_GOOGLE_ADS_CONVERSION_LABEL;
---

{
  GOOGLE_ADS_ID && (
    <>
      <div 
        id="google-ads-config" 
        data-ads-id={GOOGLE_ADS_ID} 
        data-conversion-label={GOOGLE_ADS_CONVERSION_LABEL}
        style="display:none;"
      ></div>
      <script>
        // Función global para eventos generales (Remarketing, etc.)
        // @ts-ignore
        window.trackGoogleAdsEvent = function(eventName, params = {}) {
          // @ts-ignore
          if (typeof window.gtag === 'function') {
             if (import.meta.env.DEV) {
              console.log('Evento Google Ads:', eventName, params);
            }
            // @ts-ignore
            window.gtag('event', eventName, params);
          }
        };

        // Función global para conversiones
        // @ts-ignore
        window.triggerContactConversion = function() {
          const config = document.getElementById('google-ads-config');
          if (!config) return;
          
          const GOOGLE_ADS_ID = config.dataset.adsId;
          const CONVERSION_LABEL = config.dataset.conversionLabel;

          // @ts-ignore
          if (GOOGLE_ADS_ID && CONVERSION_LABEL && typeof window.gtag === 'function') {
            if (import.meta.env.DEV) {
              console.log('Disparando conversión de Google Ads:', `${GOOGLE_ADS_ID}/${CONVERSION_LABEL}`);
            }
            // @ts-ignore
            window.gtag('event', 'conversion', {
              'send_to': `${GOOGLE_ADS_ID}/${CONVERSION_LABEL}`
            });
          } else if (import.meta.env.DEV) {
             console.log('Conversión no enviada: Faltan IDs o gtag no está listo');
          }
        };

        function trackPageView() {
            const config = document.getElementById('google-ads-config');
            if (!config) return;
            const GOOGLE_ADS_ID = config.dataset.adsId;
            
            // @ts-ignore
            if (typeof window.gtag === 'function') {
                if (import.meta.env.DEV) {
                    console.log('Google Ads: Enviando page_view para', window.location.pathname);
                }
                // @ts-ignore
                window.gtag('config', GOOGLE_ADS_ID, {
                    'page_path': window.location.pathname,
                    'page_title': document.title
                });
            }
        }

        function loadGoogleAds() {
          const config = document.getElementById('google-ads-config');
          if (!config) return;
          
          const GOOGLE_ADS_ID = config.dataset.adsId;
          if (!GOOGLE_ADS_ID) return;

          // Si ya está cargado, solo trackeamos la vista
          if (document.getElementById('google-ads-script')) {
              trackPageView();
              return;
          }

          if (import.meta.env.DEV) {
              console.log('Cargando Google Ads con Partytown...');
          }

          // Script principal de Gtag
          const script = document.createElement('script');
          script.id = 'google-ads-script';
          script.type = 'text/partytown';
          script.src = `https://www.googletagmanager.com/gtag/js?id=${GOOGLE_ADS_ID}`;
          document.head.appendChild(script);

          // Script de configuración inicial
          const inlineScript = document.createElement('script');
          inlineScript.type = 'text/partytown';
          inlineScript.innerHTML = `
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', '${GOOGLE_ADS_ID}');
          `;
          document.head.appendChild(inlineScript);
        }

        // Manejo de eventos
        document.addEventListener('cookie-consent:accepted', loadGoogleAds);
        
        // En navegaciones subsiguientes con ClientRouter
        document.addEventListener('astro:page-load', () => {
            // @ts-ignore
            if (window.cookieConsentAccepted || document.getElementById('google-ads-script')) {
                trackPageView();
            } else {
                // Verificar si ya se aceptó antes (caso borde)
                // @ts-ignore
                if (window.cookieConsentAccepted) {
                    loadGoogleAds();
                }
            }
        });
        
        // Carga inicial si ya hay consentimiento
        // @ts-ignore
        if (window.cookieConsentAccepted) {
            loadGoogleAds();
        }
      </script>
    </>
  )
}
