---
const GOOGLE_ADS_ID = import.meta.env.PUBLIC_GOOGLE_ADS_ID;
const GOOGLE_ADS_CONVERSION_LABEL = import.meta.env.PUBLIC_GOOGLE_ADS_CONVERSION_LABEL;
---

{
  GOOGLE_ADS_ID && (
    <>
      <div 
        id="google-ads-config" 
        data-ads-id={GOOGLE_ADS_ID} 
        data-conversion-label={GOOGLE_ADS_CONVERSION_LABEL}
        style="display:none;"
      ></div>
      <script is:inline define:vars={{ isDev: import.meta.env.DEV }}>
        // Función global para eventos generales (Remarketing, etc.)
        // @ts-ignore
        window.trackGoogleAdsEvent = function(eventName, params = {}) {
          // @ts-ignore
          if (typeof window.gtag === 'function') {
             // @ts-ignore
             if (isDev) {
              console.log('Evento Google Ads:', eventName, params);
            }
            // @ts-ignore
            window.gtag('event', eventName, params);
          }
        };

        // Función global para conversiones
        // @ts-ignore
        window.triggerContactConversion = function() {
          const config = document.getElementById('google-ads-config');
          if (!config) return;
          
          const GOOGLE_ADS_ID = config.dataset.adsId;
          const CONVERSION_LABEL = config.dataset.conversionLabel;

          // @ts-ignore
          if (GOOGLE_ADS_ID && CONVERSION_LABEL && typeof window.gtag === 'function') {
            // @ts-ignore
            if (isDev) {
              console.log('Disparando conversión de Google Ads:', `${GOOGLE_ADS_ID}/${CONVERSION_LABEL}`);
            }
            // @ts-ignore
            window.gtag('event', 'conversion', {
              'send_to': `${GOOGLE_ADS_ID}/${CONVERSION_LABEL}`
            });
          } else {
             // @ts-ignore
             if (isDev) {
                console.log('Conversión no enviada: Faltan IDs o gtag no está listo');
             }
          }
        };

        function trackPageView() {
            const config = document.getElementById('google-ads-config');
            if (!config) return;
            const GOOGLE_ADS_ID = config.dataset.adsId;
            
            // @ts-ignore
            if (typeof window.gtag === 'function') {
                // @ts-ignore
                if (isDev) {
                    console.log('Google Ads: Enviando page_view para', window.location.pathname);
                }
                // @ts-ignore
                window.gtag('config', GOOGLE_ADS_ID, {
                    'page_path': window.location.pathname,
                    'page_title': document.title
                });
            }
        }

        function loadGoogleAds() {
          const config = document.getElementById('google-ads-config');
          if (!config) return;
          
          const GOOGLE_ADS_ID = config.dataset.adsId;
          if (!GOOGLE_ADS_ID) return;

          // Evitar cargar si ya está cargado
          if (document.getElementById('google-ads-script')) return;

          // @ts-ignore
          if (isDev) {
              console.log('Cargando Google Ads con Partytown...');
          }

          // Script principal de Gtag
          const script = document.createElement('script');
          script.id = 'google-ads-script';
          script.type = 'text/partytown';
          script.src = `https://www.googletagmanager.com/gtag/js?id=${GOOGLE_ADS_ID}`;
          document.head.appendChild(script);

          // Script de configuración inicial (SIN config, solo js date)
          const inlineScript = document.createElement('script');
          inlineScript.type = 'text/partytown';
          inlineScript.innerHTML = `
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
          `;
          document.head.appendChild(inlineScript);
        }

        // Manejo de eventos
        document.addEventListener('cookie-consent:accepted', () => {
            loadGoogleAds();
            // Esperar un poco a que partytown procese, o confiar en que gtag encolará
            setTimeout(trackPageView, 100); 
        });
        
        // En navegaciones subsiguientes con ClientRouter Y carga inicial
        document.addEventListener('astro:page-load', () => {
            // @ts-ignore
            if (window.cookieConsentAccepted || document.getElementById('google-ads-script')) {
                // Si ya tenemos script, trackeamos. 
                // Si acabamos de cargar la página (initial load), loadGoogleAds se habrá llamado abajo
                // pero NO habrá mandado config. Así que aquí mandamos config.
                trackPageView();
            }
        });
        
        // Carga inicial del script si ya hay consentimiento (pero NO trackea pageview, eso lo hace astro:page-load)
        // @ts-ignore
        if (window.cookieConsentAccepted) {
            loadGoogleAds();
        }
      </script>
    </>
  )
}
