---
import Layout from "../layouts/Layout.astro";
import { Image } from "astro:assets";
import { getImage } from "astro:assets";
import ContactHeroImage from "@assets/img/contacto.webp";
import data from "@data";

// Components
import ContactForm from "@components/contact/ContactForm.astro";
import ContactInfo from "@components/contact/ContactInfo.astro";
import MapSection from "@components/contact/MapSection.astro";

const contact = data.contact;
const contactPage = data.contactPage;

if (!contactPage) {
    throw new Error('contactPage data is missing from data.json');
}

const { hero, form, info, map } = contactPage;

const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;
const TRACK_FORM_START = import.meta.env.PUBLIC_GOOGLE_ADS_TRACK_FORM_START === 'true';

const blurImage = await getImage({
    src: ContactHeroImage,
    format: "webp",
    width: 150,
    quality: 50
});
---

<Layout
    title="Contacto - Solicita tu presupuesto | Barreto Construcciones"
    description="Contacta con Barreto Construcciones. Estamos en Madrid y Toledo. Solicita tu presupuesto sin compromiso para tu proyecto de construcci贸n o rehabilitaci贸n."
    keywords="contacto barreto construcciones, presupuesto construcci贸n, contacto Madrid Toledo, solicitar presupuesto obra"
    canonical="/contacto"
>
    <!-- Hero Section -->
    <section class="relative border-b border-neutral-200 bg-neutral-900 py-16 md:py-20 overflow-hidden" aria-labelledby="contact-hero-title">
        <div class="absolute inset-0">
            {/* Low Res Placeholder */}
            <img
                src={blurImage.src}
                alt=""
                class="hero-image-anim absolute inset-0 w-full h-full object-cover brightness-[0.3] contrast-[1.1] blur-sm"
                aria-hidden="true"
            />

            {/* High Res Image */}
            <Image
                src={ContactHeroImage}
                alt="Oficinas de Barreto Construcciones"
                class="hero-image-high hero-image-anim w-full h-full object-cover brightness-[0.5] contrast-[1.1] opacity-0 transition-opacity duration-1500 ease-out"
                loading="eager"
                fetchpriority="high"
                quality={90}
                widths={[640, 1024, 1536, 2048]}
                sizes="100vw"
                format="avif"
            />
        </div>

        <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="max-w-3xl mx-auto text-center bg-white/10 backdrop-blur-md rounded-2xl p-8 md:p-12 shadow-xl border border-white/20">
                <div class="inline-flex items-center rounded-full border border-primary-200/30 bg-white/90 px-4 py-1.5 text-sm font-semibold mb-4">
                    <span class="text-primary-700">{hero.badge}</span>
                </div>
                <h1 id="contact-hero-title" class="text-4xl sm:text-5xl md:text-6xl font-bold text-white mb-6 tracking-tight">
                    {hero.title}
                </h1>
                <p class="text-xl text-neutral-100 leading-relaxed">
                    {hero.subtitle}
                </p>
            </div>
        </div>
    </section>

    <!-- Contact Section -->
    <section class="py-16 md:py-20 lg:py-24" aria-label="Secci贸n de contacto">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16">
                
                <!-- Contact Form -->
                <div class="order-1">
                    <ContactForm 
                        title={form.title}
                        fields={form.fields}
                        privacidadLink={form.privacidadLink}
                        submitButton={form.submitButton}
                    />
                </div>

                <!-- Contact Information -->
                <div class="order-2">
                    <ContactInfo 
                        title={info.title}
                        subtitle={info.subtitle}
                        offices={contact}
                        schedule={info.schedule}
                    />
                </div>

            </div>
        </div>
    </section>

    <!-- Map Section -->
    <MapSection 
        title={map.title}
        subtitle={map.subtitle}
    />
</Layout>

<script>
    import { initContactForm } from "../scripts/contact-form";
    
    // Get config from meta tags or define vars if needed, but since this is a module script, 
    // we can't easily access define:vars from the component script directly without passing them.
    // However, we can use a small inline script to pass the env vars to a global or init function.
    
    // Better approach: Use data attributes or just inline the init call with the values.
    // But we can't import in inline scripts easily.
    
    // Let's use a custom element or just a simple event listener if we want to keep it clean.
    // Or we can just use the define:vars approach for the init call.
</script>

<script define:vars={{ RECAPTCHA_SITE_KEY, TRACK_FORM_START }}>
    // We need to import the function dynamically or ensure it's available.
    // Since we can't import inside define:vars, we have to do a hybrid approach.
    // Actually, the best way in Astro for this is to put the logic in a separate file and import it in a <script> tag without define:vars,
    // but pass the env vars via data attributes on the form or a container.
</script>

<script>
    import { initContactForm } from "../scripts/contact-form";
    
    const contactForm = document.getElementById('contactForm');
    if (contactForm) {
        // We can get these values from a data attribute if we added them to the form, 
        // or we can just rely on the fact that we are in the browser.
        // But RECAPTCHA_SITE_KEY is an env var.
        
        // Let's read from a global variable set by a previous script, or data attributes.
        const container = document.querySelector('[data-recaptcha-site-key]');
        const siteKey = container?.getAttribute('data-recaptcha-site-key') || '';
        const trackStart = container?.getAttribute('data-track-start') === 'true';
        
        if (siteKey) {
            initContactForm(siteKey, trackStart);
        }
    }

    // Hero Image Animation
    function initHeroImageLoad() {
        const images = document.querySelectorAll('.hero-image-high');
        images.forEach((img) => {
            if (img instanceof HTMLImageElement) {
                if (img.complete) {
                    img.classList.remove('opacity-0');
                } else {
                    img.addEventListener('load', () => {
                        img.classList.remove('opacity-0');
                    });
                }
            }
        });
    }

    document.addEventListener('astro:page-load', initHeroImageLoad);
    initHeroImageLoad();
</script>

<!-- Hidden element to pass env vars to script -->
<div 
    id="config-data" 
    data-recaptcha-site-key={RECAPTCHA_SITE_KEY} 
    data-track-start={TRACK_FORM_START.toString()} 
    class="hidden"
></div>

<style>
    .hero-image-anim {
        animation: subtleScale 15s alternate infinite ease-in-out;
    }

    @keyframes subtleScale {
        0% { transform: scale(1.05); }
        100% { transform: scale(1.1); }
    }

    @media (prefers-reduced-motion: reduce) {
        .hero-image-anim {
            animation: none;
            transform: none;
        }
    }
</style>
