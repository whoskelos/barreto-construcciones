---
import Footer from "@sections/Footer.astro";
import Header from "@sections/Header.astro";
import LocalBusinessSchema from "@components/LocalBusinessSchema.astro";
import { ClientRouter } from 'astro:transitions';

// reCAPTCHA Site Key (pública, segura para exponer)
const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;

interface Props {
    title?: string;
    description?: string;
    keywords?: string;
    ogImage?: string;
    ogType?: string;
    canonical?: string;
}

const {
    title = "Barreto Construcciones - Empresa de Construcción en Madrid y Toledo",
    description = "Empresa líder en construcción, edificación, obra civil, reformas y rehabilitación en Madrid y Toledo. +20 años de experiencia. Proyectos corporativos, industriales y residenciales con garantía de calidad.",
    keywords = "construcción Madrid, construcción Toledo, obra civil, edificación, reformas, rehabilitación, mantenimiento industrial, empresa construcción, construcción industrial, reformas empresas, proyectos construcción",
    ogImage = "/logo.webp",
    ogType = "website",
    canonical = Astro.url.pathname
} = Astro.props;

const siteUrl = "https://barretoconstrucciones.es";
const canonicalURL = new URL(canonical, siteUrl).href;
const fullOgImage = new URL(ogImage, siteUrl).href;
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        
        <!-- Primary Meta Tags -->
        <title>{title}</title>
        <meta name="title" content={title} />
        <meta name="description" content={description} />
        <meta name="keywords" content={keywords} />
        <meta name="author" content="Barreto Construcciones" />
        <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
        <link rel="canonical" href={canonicalURL} />
        
        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="apple-touch-icon" sizes="180x180" href="/logo.webp" />
        
        <!-- Preconnect para fuentes -->
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content={ogType} />
        <meta property="og:url" content={canonicalURL} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={fullOgImage} />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta property="og:locale" content="es_ES" />
        <meta property="og:site_name" content="Barreto Construcciones" />
        
        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content={canonicalURL} />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={fullOgImage} />
        
        <!-- Additional SEO -->
        <meta name="geo.region" content="ES-M" />
        <meta name="geo.placename" content="Madrid, Toledo" />
        <meta name="geo.position" content="40.416775;-3.703790" />
        <meta name="ICBM" content="40.416775, -3.703790" />
        
        <!-- Schema.org JSON-LD -->
        <script type="application/ld+json" set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": "GeneralContractor",
            "name": "Barreto Construcciones",
            "alternateName": "Barreto Infraestructuras",
            "description": "Empresa de construcción especializada en edificación, obra civil, reformas y rehabilitación en Madrid y Toledo",
            "url": siteUrl,
            "logo": fullOgImage,
            "image": fullOgImage,
            "telephone": ["+34925090798", "+34911460524"],
            "email": "info@barretoconstrucciones.es",
            "address": [
                {
                    "@type": "PostalAddress",
                    "addressLocality": "Yuncos",
                    "addressRegion": "Toledo",
                    "postalCode": "45210",
                    "addressCountry": "ES"
                },
                {
                    "@type": "PostalAddress",
                    "streetAddress": "Calle Gutenberg 2 - 1º Planta",
                    "addressLocality": "Getafe",
                    "addressRegion": "Madrid",
                    "postalCode": "28906",
                    "addressCountry": "ES"
                }
            ],
            "areaServed": [
                {
                    "@type": "City",
                    "name": "Madrid"
                },
                {
                    "@type": "City",
                    "name": "Toledo"
                },
                {
                    "@type": "City",
                    "name": "Getafe"
                },
                {
                    "@type": "City",
                    "name": "Yuncos"
                }
            ],
            "priceRange": "€€€",
            "foundingDate": "2000",
            "numberOfEmployees": {
                "@type": "QuantitativeValue",
                "value": "20"
            },
            "slogan": "Construimos confianza. Rehabilitamos el futuro.",
            "knowsAbout": ["Construcción", "Edificación", "Obra Civil", "Rehabilitación", "Reformas", "Mantenimiento Industrial"],
            "hasOfferCatalog": {
                "@type": "OfferCatalog",
                "name": "Servicios de Construcción",
                "itemListElement": [
                    {
                        "@type": "Offer",
                        "itemOffered": {
                            "@type": "Service",
                            "name": "Construcción Industrial",
                            "description": "Construcción de viviendas, naves y proyectos industriales en Madrid y Toledo"
                        }
                    },
                    {
                        "@type": "Offer",
                        "itemOffered": {
                            "@type": "Service",
                            "name": "Rehabilitación",
                            "description": "Rehabilitación técnica y estructural de edificios"
                        }
                    },
                    {
                        "@type": "Offer",
                        "itemOffered": {
                            "@type": "Service",
                            "name": "Obra Civil",
                            "description": "Servicios de urbanización, pavimentación, asfaltado y cimentaciones"
                        }
                    },
                    {
                        "@type": "Offer",
                        "itemOffered": {
                            "@type": "Service",
                            "name": "Mantenimiento Industrial",
                            "description": "Servicios integrales de mantenimiento de infraestructuras"
                        }
                    }
                ]
            },
            "sameAs": [
                "https://www.instagram.com/barretoconstrucciones/",
                "https://www.linkedin.com/company/barreto-construcciones/"
            ]
        })} />
        
        <!-- Schema.org WebSite para búsqueda -->
        <script type="application/ld+json" set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": "WebSite",
            "name": "Barreto Construcciones",
            "alternateName": "Barreto Infraestructuras",
            "url": siteUrl,
            "potentialAction": {
                "@type": "SearchAction",
                "target": {
                    "@type": "EntryPoint",
                    "urlTemplate": `${siteUrl}/proyectos?q={search_term_string}`
                },
                "query-input": "required name=search_term_string"
            },
            "inLanguage": "es-ES",
            "publisher": {
                "@type": "Organization",
                "name": "Barreto Construcciones",
                "logo": {
                    "@type": "ImageObject",
                    "url": fullOgImage
                }
            }
        })} />
        
        <ClientRouter />
        
        <!-- reCAPTCHA v3 -->
        {Astro.url.pathname === '/contacto' && (
            <script is:inline src={`https://www.google.com/recaptcha/api.js?render=${RECAPTCHA_SITE_KEY}`} async defer></script>
        )}
    </head>
    <body>
        <LocalBusinessSchema />
        <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
        <Header />
        <main id="main-content" class="pt-20" role="main">
            <slot />
        </main>
        <Footer />
    </body>
</html>

<style is:global>
    @import "../styles/global.css";
    @plugin "@midudev/tailwind-animations";

    :root {
        --hero-overlay: 210 15% 10%;
        --hero-text: 0 0% 100%;
    }

    /* View Transitions personalizadas - Solo Fade */
    @view-transition {
        navigation: auto;
    }

    /* Transiciones globales suaves con fade */
    ::view-transition-old(root),
    ::view-transition-new(root) {
        animation-duration: 0.3s;
        animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }

    ::view-transition-old(root) {
        animation-name: fade-out-smooth;
    }

    ::view-transition-new(root) {
        animation-name: fade-in-smooth;
    }

    /* Animaciones de fade profesionales y suaves */
    @keyframes fade-out-smooth {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }

    @keyframes fade-in-smooth {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    /* Transiciones para header y footer - Sin animación para evitar parpadeo */
    ::view-transition-old(header),
    ::view-transition-new(header),
    ::view-transition-old(footer),
    ::view-transition-new(footer) {
        animation: none;
    }

    ::view-transition-group(header),
    ::view-transition-group(footer) {
        animation-duration: 0s;
        z-index: 9999;
    }

    ::view-transition-group(header) {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
    }

    /* Transiciones para imágenes - Solo fade */
    ::view-transition-old(img-edificacion),
    ::view-transition-new(img-edificacion),
    ::view-transition-old(img-obra-civil),
    ::view-transition-new(img-obra-civil),
    ::view-transition-old(img-reformas),
    ::view-transition-new(img-reformas),
    ::view-transition-old(img-rehabilitacion),
    ::view-transition-new(img-rehabilitacion),
    ::view-transition-old(img-mantenimiento),
    ::view-transition-new(img-mantenimiento) {
        animation-duration: 0.5s;
        animation-timing-function: ease-out;
        /* Mantener la posición fija durante la transición */
        mix-blend-mode: normal;
    }

    ::view-transition-old(img-edificacion),
    ::view-transition-old(img-obra-civil),
    ::view-transition-old(img-reformas),
    ::view-transition-old(img-rehabilitacion),
    ::view-transition-old(img-mantenimiento) {
        animation-name: fade-out-smooth;
    }

    ::view-transition-new(img-edificacion),
    ::view-transition-new(img-obra-civil),
    ::view-transition-new(img-reformas),
    ::view-transition-new(img-rehabilitacion),
    ::view-transition-new(img-mantenimiento) {
        animation-name: fade-in-smooth;
    }

    /* Prevenir el parpadeo blanco durante las transiciones */
    ::view-transition-group(img-edificacion),
    ::view-transition-group(img-obra-civil),
    ::view-transition-group(img-reformas),
    ::view-transition-group(img-rehabilitacion),
    ::view-transition-group(img-mantenimiento) {
        animation-duration: 0.5s;
        animation-timing-function: ease-out;
    }

    /* Mejora de rendimiento para View Transitions */
    @media (prefers-reduced-motion: reduce) {
        ::view-transition-old(root),
        ::view-transition-new(root),
        ::view-transition-old(img-edificacion),
        ::view-transition-new(img-edificacion),
        ::view-transition-old(img-obra-civil),
        ::view-transition-new(img-obra-civil),
        ::view-transition-old(img-reformas),
        ::view-transition-new(img-reformas),
        ::view-transition-old(img-rehabilitacion),
        ::view-transition-new(img-rehabilitacion),
        ::view-transition-old(img-mantenimiento),
        ::view-transition-new(img-mantenimiento) {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
        }
    }
</style>

<style>
    html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background-color: white;
    }

    body {
        margin: 0;
        padding: 0;
        width: 100%;
        min-height: 100vh;
        font-family: "Roboto", sans-serif;
        background-color: var(--color-neutral-50);
        display: flex;
        flex-direction: column;
    }

    main {
        flex: 1 0 auto;
        width: 100%;
    }

    footer {
        flex-shrink: 0;
    }

    /* Skip navigation link for accessibility */
    .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: #000;
        color: #fff;
        padding: 8px 16px;
        text-decoration: none;
        z-index: 10000;
        font-weight: bold;
        border-radius: 0 0 4px 0;
    }

    .skip-link:focus {
        top: 0;
    }
</style>
